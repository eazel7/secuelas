#! /usr/bin/env node

const validEmailRegex = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
const API = require('../backend-api/api');
const config = require('config');
const EventEmitter = require('events').EventEmitter;

require('async')
    .autoInject({
        db: function(callback) {
            require('mongodb').MongoClient.connect(config.api.db, callback);
        },
        bus: function(callback) {
            var bus = new EventEmitter();
            bus.setMaxListeners(0);

            callback(null, bus);
        },
        api: function(db, bus, callback) {
            callback(null, new API(config.api, db, bus));
        },
        answers: function(callback) {
            var argv = require('minimist')(process.argv);

            var inquirer = require('inquirer');

            inquirer.prompt([]).then(function(answers) {
                callback(null, answers);
            }, function(err) {
                callback(err || new Error());
            });
        },
        password: function(answers, api, callback) {
            return api.users.generateRandomPassword()
            .then(
                (password) => callback(null, password),
                (err) => callback(err || new Error('failed to generate random password'))
            );
        }
    }, function(err, results) {
        if (err) {
            console.error(err.toString());
            return process.exit(-1);
        }
        process.stdout.write(require('js-yaml').safeDump(results.password));

        return process.exit();
    });
